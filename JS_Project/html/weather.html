<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚ ì”¨ ìœ„ì ¯</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f7fa;
      padding: 10px;
      margin: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .widget {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 280px;
      font-size: 14px;
    }

    .weather-icon {
      width: 40px;
      vertical-align: middle;
    }

    select, button {
      padding: 4px;
      margin-top: 8px;
      font-size: 14px;
    }

    h3 {
      margin: 10px 0;
    }

    p {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <div class="widget">
    <strong>ë‚ ì”¨ ìœ„ì ¯</strong><br>
    <select id="location">
      <optgroup label="ì„œìš¸íŠ¹ë³„ì‹œ">
        <option value="ì„œìš¸ ì¢…ë¡œêµ¬">ì„œìš¸ ì¢…ë¡œêµ¬</option>
        <option value="ì„œìš¸ ê°•ë‚¨êµ¬">ì„œìš¸ ê°•ë‚¨êµ¬</option>
      </optgroup>
      <optgroup label="ë¶€ì‚°ê´‘ì—­ì‹œ">
        <option value="ë¶€ì‚° í•´ìš´ëŒ€êµ¬">ë¶€ì‚° í•´ìš´ëŒ€êµ¬</option>
        <option value="ë¶€ì‚° ë‚¨êµ¬">ë¶€ì‚° ë‚¨êµ¬</option>
      </optgroup>
      <optgroup label="ì œì£¼íŠ¹ë³„ìì¹˜ë„">
        <option value="ì œì£¼ ì œì£¼ì‹œ">ì œì£¼ ì œì£¼ì‹œ</option>
        <option value="ì œì£¼ ì„œê·€í¬ì‹œ">ì œì£¼ ì„œê·€í¬ì‹œ</option>
      </optgroup>
    </select>
    <button onclick="getWeather()">í™•ì¸</button>

    <div id="weather" style="margin-top: 10px;"></div>
  </div>

  <script>
    const locationMap = {
      "ì„œìš¸ ì¢…ë¡œêµ¬": { lat: 37.5729503, lon: 126.9793579 },
      "ì„œìš¸ ê°•ë‚¨êµ¬": { lat: 37.5172363, lon: 127.0473248 },
      "ë¶€ì‚° í•´ìš´ëŒ€êµ¬": { lat: 35.1631, lon: 129.1635 },
      "ë¶€ì‚° ë‚¨êµ¬": { lat: 35.1360, lon: 129.0845 },
      "ì œì£¼ ì œì£¼ì‹œ": { lat: 33.4996, lon: 126.5312 },
      "ì œì£¼ ì„œê·€í¬ì‹œ": { lat: 33.2530, lon: 126.5602 }
    };

    function dfs_xy_conv(lat, lon) {
      const RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0;
      const XO = 43, YO = 136, DEGRAD = Math.PI / 180.0;
      let re = RE / GRID;
      let slat1 = SLAT1 * DEGRAD;
      let slat2 = SLAT2 * DEGRAD;
      let olon = OLON * DEGRAD;
      let olat = OLAT * DEGRAD;

      let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
      sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
      let sf = Math.pow(Math.tan(Math.PI * 0.25 + slat1 * 0.5), sn) * Math.cos(slat1) / sn;
      let ro = re * sf / Math.pow(Math.tan(Math.PI * 0.25 + olat * 0.5), sn);
      let ra = re * sf / Math.pow(Math.tan(Math.PI * 0.25 + lat * DEGRAD * 0.5), sn);
      let theta = lon * DEGRAD - olon;
      if (theta > Math.PI) theta -= 2.0 * Math.PI;
      if (theta < -Math.PI) theta += 2.0 * Math.PI;
      theta *= sn;

      let x = Math.floor(ra * Math.sin(theta) + XO + 0.5);
      let y = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
      return { nx: x, ny: y };
    }

    async function getWeather() {
      const selected = document.getElementById('location').value;
      const { lat, lon } = locationMap[selected];
      const { nx, ny } = dfs_xy_conv(lat, lon);

      const today = new Date();
      const base_date = today.toISOString().slice(0, 10).replace(/-/g, '');
      const base_time = "0500";
      const serviceKey = "d6cF3Nnyo1mIeT9LM8Xrs8Rq%2F9TG0TVk12HMlpbx44t71s%2F5sE8TMkBVxyPfxdpcI7miaLI75YAF82Bfl3tXSw%3D%3D"; // â† ì‹¤ì œ ì¸ì¦í‚¤ë¡œ ë°”ê¿”ì£¼ì„¸ìš”

      const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${base_date}&base_time=${base_time}&nx=${nx}&ny=${ny}`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        const items = data.response.body.items.item;

        const sky = items.find(i => i.category === 'SKY' && i.fcstTime === '0900');
        const pty = items.find(i => i.category === 'PTY' && i.fcstTime === '0900');
        const tmp = items.find(i => i.category === 'TMP' && i.fcstTime === '0900');
        const reh = items.find(i => i.category === 'REH' && i.fcstTime === '0900');

        const icon = getWeatherIcon(sky?.fcstValue, pty?.fcstValue);
        const container = document.getElementById('weather');

        container.innerHTML = `
          <h3>${selected}</h3>
          <img src="${icon}" class="weather-icon" alt="ë‚ ì”¨ ì•„ì´ì½˜">
          <p>ìƒíƒœ: ${getSkyText(sky?.fcstValue, pty?.fcstValue)}</p>
          <p>ê¸°ì˜¨: ${tmp?.fcstValue}â„ƒ</p>
          <p>ìŠµë„: ${reh?.fcstValue}%</p>
        `;
      } catch (err) {
        document.getElementById('weather').innerText = "ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        console.error(err);
      }
    }

    function getWeatherIcon(sky, pty) {
      if (pty === '1') return 'https://openweathermap.org/img/wn/10d.png';
      if (pty === '2') return 'https://openweathermap.org/img/wn/13d.png';
      if (pty === '3') return 'https://openweathermap.org/img/wn/13d.png';
      if (sky === '1') return 'https://openweathermap.org/img/wn/01d.png';
      if (sky === '3') return 'https://openweathermap.org/img/wn/03d.png';
      if (sky === '4') return 'https://openweathermap.org/img/wn/04d.png';
      return '';
    }

    function getSkyText(sky, pty) {
      if (pty === '1') return 'ğŸŒ§ ë¹„';
      if (pty === '2') return 'ğŸŒ¨ ë¹„/ëˆˆ';
      if (pty === '3') return 'â„ï¸ ëˆˆ';
      if (sky === '1') return 'â˜€ï¸ ë§‘ìŒ';
      if (sky === '3') return 'â›… êµ¬ë¦„ ë§ìŒ';
      if (sky === '4') return 'â˜ï¸ íë¦¼';
      return 'ì •ë³´ ì—†ìŒ';
    }
  </script>
</body>
</html>